<!DOCTYPE html>
<html lang="it">
<head>
    <link rel="icon" href="data:,">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>United-and-Close - Area Personale</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="../public/css/style.css">
    <link rel="stylesheet" href="../public/css/spiderChartStyle.css">
    <link rel="stylesheet" href="../public/css/searchStyle.css">
    <link rel="stylesheet" href="../public/css/personalStyle.css">

</head>

<body>
<div id="navbar-container"></div>

<!-- Logout button positioned correctly below navbar -->
<div id="logout-container" class="position-fixed" style="top: 70px; right: 20px; z-index: 1040; display: none;">
    <button class="btn btn-outline-danger" type="button" id="logout-btn">
        <i class="bi bi-box-arrow-right me-1"></i>
        Logout
    </button>
</div>

<!-- Welcome message -->
<div id="welcome-section" class="text-center py-3" style="display: none; margin-top: 100px;">
    <i class="bi bi-person-check-circle text-primary" style="font-size: 3rem;"></i>
    <h4 class="mt-2 text-primary" id="welcome-message"></h4>
</div>

<!-- Travel settings display -->
<div id="travel-settings-display" class="text-center py-3" style="display: none; margin-top: 20px;">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title text-primary mb-3">
                            <i class="bi bi-gear me-2"></i>
                            Current Travel Settings
                        </h6>
                        <div class="row">
                            <div class="col-6">
                                <div class="d-flex align-items-center justify-content-center">
                                    <i class="bi bi-clock me-2 text-muted"></i>
                                    <span id="selected-time" class="fw-bold">15 min</span>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="d-flex align-items-center justify-content-center">
                                    <i class="bi bi-person-walking me-2 text-muted"></i>
                                    <span id="selected-mode" class="fw-bold">Walking</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Selected services display - centered under welcome -->
<div id="selected-services-center" class="text-center py-4" style="display: none; margin-top: 20px;">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <h5 class="mb-3 text-primary">
                    <i class="bi bi-list-check me-2"></i>
                    Selected Services
                </h5>
                <div class="selected-services-center border rounded" style="background-color: #f8f9fa; min-height: 80px;">
                    <p class="text-muted text-center mb-0">
                        <i class="bi bi-info-circle me-2"></i>
                        Selected services will appear here
                    </p>
                </div>
                <!-- Change Favorite Settings Button -->
                <div class="mt-4">
                    <button class="btn btn-outline-primary" type="button" id="change-settings-btn">
                        <i class="bi bi-gear me-2"></i>
                        Change Favorite Settings
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Settings section - identical to search page -->
<div id="settings-section" class="overlay-sidebar" style="display: none;">
    <div class="sidebar-content">
        <div class="p-4">
            <div class="mb-4">
                <label class="form-label">Select time and mode of travel</label>
                <div class="inline-group mb-2">
                    <select class="form-select time-select">
                        <option>5 min</option>
                        <option>10 min</option>
                        <option selected>15 min</option>
                        <option>20 min</option>
                    </select>
                    <div class="btn-group">
                        <button type="button" class="btn btn-outline-primary active">
                            <i class="bi bi-person-walking icon-color"></i>
                        </button>
                        <button type="button" class="btn btn-outline-primary">
                            <i class="fa-solid fa-person-walking-with-cane icon-color"></i>
                        </button>
                        <button type="button" class="btn btn-outline-primary">
                            <i class="bi bi-bicycle icon-color"></i>
                        </button>
                        <button type="button" class="btn btn-outline-primary">
                            <i class="bi bi-train-front icon-color"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="mb-4">
                <label class="form-label">Select services to be displayed in the area</label>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <button class="btn btn-outline-primary btn-sm" type="button" id="select-all-categories">
                        <i class="fas fa-square"></i> Select All Categories
                    </button>
                </div>
                <div class="light-gray-container" style="max-height: 600px; overflow-y: auto;">
                    <div class="pointOfInterest-container" id="services-container"></div>
                </div>
            </div>

            <div class="d-flex justify-content-center">
                <button class="btn custom-primary small-btn" type="button" id="save-settings-btn">Save Settings</button>
            </div>
        </div>
    </div>
</div>

<!-- Login/Register buttons pre autenticazione -->
<div id="auth-buttons" class="text-center py-5" style="margin-top: 100px;">
    <i class="bi bi-person-circle text-muted" style="font-size: 4rem;"></i>
    <h4 class="mt-3 text-muted">Login or Register</h4>
    <p class="text-muted">Choose how you want to proceed to access your personal area.</p>
    <div class="d-grid gap-3 d-md-block">
        <button class="btn btn-primary btn-lg me-2" type="button" id="show-login-btn">
            <i class="bi bi-box-arrow-in-right me-2"></i>
            Login
        </button>
        <button class="btn btn-outline-primary btn-lg" type="button" id="show-register-btn">
            <i class="bi bi-person-plus me-2"></i>
            Register
        </button>
    </div>
</div>

<!-- Login Form -->
<div id="login-form" class="card mx-auto" style="display: none; max-width: 400px; margin-top: 100px;">
    <div class="card-body">
        <h4 class="card-title text-center mb-4">
            <i class="bi bi-box-arrow-in-right me-2"></i>
            Login
        </h4>
        <form id="login-form-element">
            <div class="mb-3">
                <label for="login-email" class="form-label">Email</label>
                <input type="email" class="form-control" id="login-email" required>
            </div>
            <div class="mb-3">
                <label for="login-password" class="form-label">Password</label>
                <input type="password" class="form-control" id="login-password" required>
            </div>
            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-box-arrow-in-right me-2"></i>
                    Login
                </button>
                <button type="button" class="btn btn-outline-secondary" id="back-to-buttons">
                    <i class="bi bi-arrow-left me-2"></i>
                    Back
                </button>
            </div>
        </form>
        <div id="login-error" class="alert alert-danger mt-3" style="display: none;"></div>
    </div>
</div>

<!-- Register Form -->
<div id="register-form" class="card mx-auto" style="display: none; max-width: 400px; margin-top: 100px;">
    <div class="card-body">
        <h4 class="card-title text-center mb-4">
            <i class="bi bi-person-plus me-2"></i>
            Register
        </h4>
        <form id="register-form-element">
            <div class="mb-3">
                <label for="register-email" class="form-label">Email</label>
                <input type="email" class="form-control" id="register-email" required>
            </div>
            <div class="mb-3">
                <label for="register-password" class="form-label">Password</label>
                <input type="password" class="form-control" id="register-password" required>
            </div>
            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-person-plus me-2"></i>
                    Register
                </button>
                <button type="button" class="btn btn-outline-secondary" id="back-to-buttons-register">
                    <i class="bi bi-arrow-left me-2"></i>
                    Back
                </button>
            </div>
        </form>
        <div id="register-error" class="alert alert-danger mt-3" style="display: none;"></div>
        <div id="register-success" class="alert alert-success mt-3" style="display: none;"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://kit.fontawesome.com/081eecd135.js" crossorigin="anonymous"></script>

<script type="module" src="../public/js/components/ServiceCategory.js"></script>

<script type="module">
    import { servicesList } from '../public/js/config/servicesList.js';

    document.addEventListener('DOMContentLoaded', () => {
        const container = document.getElementById('services-container');
        const selectedServicesDiv = document.querySelector('.selected-services-center');
        const selectAllButton = document.getElementById('select-all-categories');

        // Initialize services only if container exists (when user is logged in)
        if (container) {
            Object.values(servicesList).forEach(category => {
                const element = document.createElement('service-category');
                element.setAttribute('title', category.title);
                element.setAttribute('services', JSON.stringify(category.services));
                container.appendChild(element);
            });

            let allSelected = false;
            let selectedCategories = new Set();
            
            // Event listener per gestire i cambiamenti dei servizi (identico alla search page)
            document.addEventListener('service-changed', (e) => {
                const { id, label, checked, isMainCategory, isFromSelectAll } = e.detail;
                if (isFromSelectAll) {
                    if (checked) {
                        if (!selectedCategories.has(id)) {
                            selectedCategories.add(id);
                            addServiceBadge(id, label);
                        }
                    } else {
                        if (selectedCategories.has(id)) {
                            selectedCategories.delete(id);
                            removeServiceBadge(label);
                        }
                    }
                }
                else{
                    if (checked) {
                        selectedCategories.add(id);
                        addServiceBadge(id, label);
                    } else {
                        selectedCategories.delete(id);
                        removeServiceBadge(label);
                    }
                }
            });

            // Funzioni per gestire i badge dei servizi selezionati (identiche alla search page)
            function addServiceBadge(id, label) {
                // Rimuovi il messaggio di default se presente
                const defaultMessage = selectedServicesDiv.querySelector('p.text-muted');
                if (defaultMessage) {
                    defaultMessage.remove();
                }
                
                const badge = document.createElement('span');
                badge.classList.add('badge', 'bg-primary', 'me-1', 'mb-1', 'fs-7', 'px-2', 'py-1');
                badge.dataset.categoryId = id;
                badge.innerHTML = `${label} <i class="bi bi-x ms-1"></i>`;
                badge.querySelector('i').addEventListener('click', () => {
                    const categoryId = badge.dataset.categoryId;
                    selectedCategories.delete(categoryId);
                    badge.remove();

                    // Se non ci sono più badge, mostra il messaggio di default
                    if (selectedServicesDiv.children.length === 0) {
                        selectedServicesDiv.innerHTML = '<p class="text-muted text-center mb-0"><i class="bi bi-info-circle me-2"></i>Selected services will appear here</p>';
                    }


                    document.querySelectorAll('service-category').forEach(component => {
                        const checkbox = component.shadowRoot?.querySelector(`input#${categoryId}`);
                        if (checkbox) {
                            checkbox.checked = false;
                        }
                    });
                });
                selectedServicesDiv.appendChild(badge);
            }

            function removeServiceBadge(label) {
                const badges = selectedServicesDiv.querySelectorAll('.badge');
                badges.forEach(badge => {
                    if (badge.textContent.includes(label)) {
                        const categoryId = badge.dataset.categoryId;
                        badge.remove();

                        // Se non ci sono più badge, mostra il messaggio di default
                        if (selectedServicesDiv.children.length === 0) {
                            selectedServicesDiv.innerHTML = '<p class="text-muted text-center mb-0"><i class="bi bi-info-circle me-2"></i>Selected services will appear here</p>';
                        }


                        document.querySelectorAll('service-category').forEach(component => {
                            const checkbox = component.shadowRoot?.querySelector(`input#${categoryId}`);
                            if (checkbox) {
                                checkbox.checked = false;
                            }
                        });
                    }
                });
            }

            
            selectAllButton.addEventListener('click', () => {
                const serviceCategories = container.querySelectorAll('service-category');
                
                if (!allSelected) {
                    //seleziona tutto
                    serviceCategories.forEach(category => {
                        const checkboxes = category.shadowRoot.querySelectorAll('input[type="checkbox"]');
                        checkboxes.forEach(checkbox => {
                            if (!checkbox.checked) {
                                checkbox.checked = true;
                                checkbox.dispatchEvent(new Event('change'));
                            }
                        });
                    });
                    
                    selectAllButton.innerHTML = '<i class="fas fa-check-square"></i> Deselect All Categories';
                    allSelected = true;
                } else {
                    //deseleziona tutto
                    serviceCategories.forEach(category => {
                        const checkboxes = category.shadowRoot.querySelectorAll('input[type="checkbox"]');
                        checkboxes.forEach(checkbox => {
                            if (checkbox.checked) {
                                checkbox.checked = false;
                                checkbox.dispatchEvent(new Event('change'));
                            }
                        });
                    });
                    
                    selectAllButton.innerHTML = '<i class="fas fa-square"></i> Select All Categories';
                    allSelected = false;
                }
            });
        }

        // Gestione bottoni modalità di viaggio - identica alla search page
        const travelModeButtons = document.querySelectorAll('#settings-section .btn-group .btn');
        travelModeButtons.forEach(button => {
            button.addEventListener('click', () => {
                // Rimuovi classe active da tutti i bottoni
                travelModeButtons.forEach(btn => btn.classList.remove('active'));
                // Aggiungi classe active al bottone cliccato
                button.classList.add('active');
                
                // Aggiorna la visualizzazione delle impostazioni di viaggio
                updateTravelSettingsDisplay();
            });
        });

        // Gestione selezione tempo
        const timeSelect = document.querySelector('#settings-section .time-select');
        if (timeSelect) {
            timeSelect.addEventListener('change', () => {
                updateTravelSettingsDisplay();
            });
        }

        // Funzione per aggiornare la visualizzazione delle impostazioni di viaggio
        function updateTravelSettingsDisplay() {
            const selectedTimeElement = document.getElementById('selected-time');
            const selectedModeElement = document.getElementById('selected-mode');
            
            if (selectedTimeElement && timeSelect) {
                selectedTimeElement.textContent = timeSelect.value;
            }
            
            if (selectedModeElement) {
                const activeButton = document.querySelector('#settings-section .btn-group .btn.active');
                if (activeButton) {
                    const icon = activeButton.querySelector('i');
                    if (icon) {
                        // Mappa delle icone ai nomi delle modalità
                        const modeMap = {
                            'bi-person-walking': 'Walking',
                            'fa-person-walking-with-cane': 'Walking with cane',
                            'bi-bicycle': 'Cycling',
                            'bi-train-front': 'Public transport'
                        };
                        
                        const modeClass = Array.from(icon.classList).find(cls => 
                            modeMap[cls] !== undefined
                        );
                        
                        selectedModeElement.textContent = modeClass ? modeMap[modeClass] : 'Walking';
                    }
                }
            }
        }

        // Gestione bottoni azione
        const saveSettingsBtn = document.getElementById('save-settings-btn');
        const changeSettingsBtn = document.getElementById('change-settings-btn');
        const settingsSection = document.getElementById('settings-section');

        if (saveSettingsBtn) {
            saveSettingsBtn.addEventListener('click', async () => {
                try {
                    // Collect current settings
                    const timeSelect = document.querySelector('.time-select');
                    const timeValue = timeSelect ? parseInt(timeSelect.value) : 15;
                    
                    // Get active travel mode button and determine velocity
                    const activeButton = document.querySelector('#settings-section .btn-group .btn.active');
                    let velocity = 5; // default to walking
                    if (activeButton) {
                        const icon = activeButton.querySelector('i');
                        if (icon) {
                            const iconClass = Array.from(icon.classList).find(cls => 
                                ['bi-person-walking', 'fa-person-walking-with-cane', 'bi-bicycle', 'bi-train-front'].includes(cls)
                            );
                            const velocityMap = {
                                'bi-person-walking': 5,
                                'fa-person-walking-with-cane': 3,
                                'bi-bicycle': 12,
                                'bi-train-front': 20
                            };
                            velocity = velocityMap[iconClass] || 5;
                        }
                    }
                    
                    // Collect selected services
                    const selectedCategories = [];
                    document.querySelectorAll('service-category').forEach(category => {
                        const checkboxes = category.shadowRoot.querySelectorAll('input[type="checkbox"]:checked');
                        checkboxes.forEach(checkbox => {
                            selectedCategories.push(checkbox.id);
                        });
                    });
                    
                    // Save preferences
                    const token = localStorage.getItem('access_token');
                    const response = await fetch('/api/auth/preferences', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            min: timeValue,
                            vel: velocity,
                            categories: selectedCategories
                        })
                    });
                    
                    if (response.ok) {
                        // Chiudi il popup
                        if (settingsSection) {
                            settingsSection.style.display = 'none';
                        }
                        
                        // Mostra feedback visivo temporaneo
                        const originalText = saveSettingsBtn.innerHTML;
                        saveSettingsBtn.innerHTML = '<i class="bi bi-check-circle me-2"></i>Salvato!';
                        saveSettingsBtn.classList.remove('btn-primary');
                        saveSettingsBtn.classList.add('btn-success');
                        
                        // Ripristina il testo originale dopo 2 secondi
                        setTimeout(() => {
                            saveSettingsBtn.innerHTML = originalText;
                            saveSettingsBtn.classList.remove('btn-success');
                            saveSettingsBtn.classList.add('btn-primary');
                        }, 2000);
                    } else {
                        throw new Error('Failed to save preferences');
                    }
                } catch (error) {
                    console.error('Error saving preferences:', error);
                    // Show error feedback
                    const originalText = saveSettingsBtn.innerHTML;
                    saveSettingsBtn.innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i>Errore!';
                    saveSettingsBtn.classList.remove('btn-primary');
                    saveSettingsBtn.classList.add('btn-danger');
                    
                    setTimeout(() => {
                        saveSettingsBtn.innerHTML = originalText;
                        saveSettingsBtn.classList.remove('btn-danger');
                        saveSettingsBtn.classList.add('btn-primary');
                    }, 2000);
                }
            });
        }


        // Event listener per il bottone "Change Favorite Settings"
        if (changeSettingsBtn) {
            changeSettingsBtn.addEventListener('click', async () => {
                if (settingsSection) {
                    settingsSection.style.display = 'block';
                    // Load current preferences and apply them to the popup
                    await loadUserPreferencesInPopup();
                }
            });
        }

        // Inizializza la visualizzazione delle impostazioni di viaggio
        updateTravelSettingsDisplay();
    });

    // Function to load user preferences and apply them to the popup
    async function loadUserPreferencesInPopup() {
        try {
            const token = localStorage.getItem('access_token');
            if (!token) return;

            const response = await fetch('/api/auth/preferences', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                const preferences = await response.json();
                applyPreferencesToPopup(preferences);
            }
        } catch (error) {
            console.error('Error loading user preferences:', error);
        }
    }

    function applyPreferencesToPopup(preferences) {
        // Apply time preference
        const timeSelect = document.querySelector('.time-select');
        if (timeSelect) {
            timeSelect.value = `${preferences.min} min`;
        }

        // Apply travel mode preference (velocity to button mapping)
        const velocityToButton = {
            3: 'fa-person-walking-with-cane',  // walking with cane
            5: 'bi-person-walking',            // walking
            12: 'bi-bicycle',                  // bicycle
            20: 'bi-train-front'               // public transport
        };

        const travelModeButtons = document.querySelectorAll('#settings-section .btn-group .btn');
        travelModeButtons.forEach(button => {
            button.classList.remove('active');
            const icon = button.querySelector('i');
            if (icon) {
                const iconClass = Array.from(icon.classList).find(cls => 
                    velocityToButton[preferences.vel] === cls
                );
                if (iconClass) {
                    button.classList.add('active');
                }
            }
        });

        // Apply services preferences
        if (preferences.categories && preferences.categories.length > 0) {
            selectServicesInPopup(preferences.categories);
        }

        // Update display
        updateTravelSettingsDisplay();
    }

    function selectServicesInPopup(categoryIds) {
        // Clear existing selections first
        document.querySelectorAll('service-category').forEach(category => {
            const checkboxes = category.shadowRoot.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
                checkbox.dispatchEvent(new Event('change'));
            });
        });

        // Process each category group to handle main category vs subcategories
        document.querySelectorAll('service-category').forEach(category => {
            const checkboxes = category.shadowRoot.querySelectorAll('input[type="checkbox"]');
            const mainCategoryCheckbox = checkboxes[0]; // First checkbox is always the main category
            const subCategoryCheckboxes = Array.from(checkboxes).slice(1); // Rest are subcategories
            
            const mainCategoryId = mainCategoryCheckbox.id;
            const selectedSubCategories = subCategoryCheckboxes.filter(cb => categoryIds.includes(cb.id));
            
            if (categoryIds.includes(mainCategoryId)) {
                // If main category is selected, select only the main category
                mainCategoryCheckbox.checked = true;
                mainCategoryCheckbox.dispatchEvent(new Event('change'));
            } else if (selectedSubCategories.length > 0) {
                // If subcategories are selected, select only the subcategories
                selectedSubCategories.forEach(checkbox => {
                    checkbox.checked = true;
                    checkbox.dispatchEvent(new Event('change'));
                });
            }
        });
    }
</script>

<script src="/public/js/navbar.js?v=2.0"></script>
<script src="/public/js/auth.js?v=1.0"></script>
</body>
</html>
